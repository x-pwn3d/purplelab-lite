# üü£ PurpleLab-lite

[![Platform](https://img.shields.io/badge/Platform-Windows%20%7C%20Linux-lightgrey)](https://github.com/x-pwn3d/mini-c2)
[![Python](https://img.shields.io/badge/Python-3.10%2B-blue)](https://www.python.org/)
[![Status](https://img.shields.io/badge/Status-Functional-brightgreen)](https://github.com/x-pwn3d/mini-c2)
![License](https://img.shields.io/badge/License-MIT-orange)
![TLS](https://img.shields.io/badge/TLS-Lab%20Certs-blue)
![Lab](https://img.shields.io/badge/Lab-Educational-lightgrey)

---

## üìñ Project Overview

**PurpleLab-lite** is a **lightweight, automated Purple Team lab** designed for cybersecurity training and testing.  
It allows security practitioners and students to **simulate real-world attack scenarios** against a vulnerable web application while automatically collecting and analyzing logs for indicators of compromise (IoCs).

Key objectives:  

- Deploy a vulnerable target: **[OWASP Juice Shop](https://owasp.org/www-project-juice-shop/)**  
- Automatically launch a variety of attacks:
  - SQL Injection (SQLi)  
  - Webshell uploads  
  - Malicious User Agents  
- Collect and analyze logs (`access.log`, `error.log`)  
- Detect IoCs using **YARA rules** and **regex patterns** (YARA is included in the Docker container)  
- Generate comprehensive automatic reports (`reports/report.md`)  

This lab is ideal for **Purple Team exercises, SIEM testing, and security education**, all on a single machine.

---

## ‚öôÔ∏è Requirements

- **Docker** & **docker-compose** installed  
- **Python 3.9+** (for local scripts if needed)  

> No need to install YARA locally, it is already included in the Docker container.

---

## üöÄ Usage

```bash
# Build and start the full lab environment (attacker + target + logs)
docker compose up --build
````

This will:

1. Launch the vulnerable Juice Shop application in a container
2. Start the attacker and harness containers to execute attack scenarios
3. Collect logs and automatically detect suspicious activity
4. Generate a Markdown report at `reports/report.md`

---

## üßæ Manual cleanup (uploads volume & persistent data)

By design the harness **no longer** tries to talk to Docker from inside the container to automatically delete volumes. You should clean persistent artifacts manually when desired.

### Remove everything including named volumes (recommended for a clean slate)

This removes containers, networks and named volumes created by compose:

```bash
docker compose down --volumes --remove-orphans
```

### Remove only the `uploads` named volume

If you want to only delete the uploads volume (keeps other volumes intact):

1. Inspect volumes to confirm the name:

```bash
docker volume ls
```

2. Remove the uploads volume by name. 

```bash
docker volume rm uploads
# or if shown as purplelab-lite_uploads
docker volume rm purplelab-lite_uploads
```

> If `docker volume rm` errors because the volume is in use, stop/remove containers first (`docker compose down`) then retry.

### Empty the volume without deleting it

If you prefer to **empty** the uploads volume (safe when you want to keep the volume object):

```bash
docker run --rm -v uploads:/data alpine sh -c "rm -rf /data/* || true; ls -la /data || true"
```

(Adjust the `uploads` name if your volume is named differently.)

## üóÇ Directory Structure

```
PurpleLab-lite/
‚îú‚îÄ‚îÄ attacks/                # Attack scripts (SQLi, webshell uploads, UA tests)
‚îú‚îÄ‚îÄ logs/                   # Logs generated by the lab (ignored by git)
‚îú‚îÄ‚îÄ reports/                # Generated reports (ignored by git)
‚îú‚îÄ‚îÄ detections/             # YARA rules for detection
‚îú‚îÄ‚îÄ harness.py              # Main orchestrator script
‚îú‚îÄ‚îÄ Dockerfile.harness      # Dockerfile for harness container
‚îú‚îÄ‚îÄ docker-compose.yml      # Compose file for lab environment
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ .gitignore
```

---

## üß© Detection & Reporting

* **YARA rules**:

  * `logs_and_webshells.yar`: Detects webshells and suspicious log patterns
  * `sqli.yar`: Detects SQLi attempts (tautologies, UNION, time-based, comment-style)
* **Regex/Grep patterns**: Detect malicious User Agents or custom keywords
* **Automatic Markdown report**: Lists all matches with files and rules triggered

---

## ‚úÖ Final verification ‚Äî example output

After running `docker compose up --build` the harness executes attacks, collects logs, runs YARA + grep detections and generates a report.

Below is a short example excerpt from `reports/report.md` produced by a successful run:

```md
#  PurpleLab-lite Security Report

 **Date (UTC):** 2025-10-28T09:40:33.634115+00:00

##  Summary
- YARA matches: **11**
- Keyword hits: **1**

##  YARA Findings
- **File:** `/app/logs/access.log`
  - Rule: `logs_and_webshells.yar`
  - Matches: `Logs_and_Webshells`
- **File:** `/data/uploads/shell_1761644427.php`
  - Rule: `logs_and_webshells.yar`
  - Matches: `Logs_and_Webshells`
- **File:** `/data/uploads/shell_1761644428.php`
  - Rule: `logs_and_webshells.yar`
  - Matches: `Logs_and_Webshells`
- **File:** `/app/logs/payload_1.json`
  - Rule: `sqli.yar`
  - Matches: `SQLi_Generic, SQLi_HighConfidence`
- **File:** `/app/logs/payload_2.json`
  - Rule: `sqli.yar`
  - Matches: `SQLi_Generic, SQLi_HighConfidence`
- **File:** `/app/logs/payload_3.json`
  - Rule: `sqli.yar`
  - Matches: `SQLi_Generic, SQLi_HighConfidence`

[...]

##  Grep Indicators
- **File:** `/app/logs/access.log`
  - Keywords: evil-scanner

##  Attacker Logs (snippet)

=== Run at 2025-10-28T09:40:19.743758+00:00 UTC ===
2025-10-28T09:40:19Z | Run start
2025-10-28T09:40:21Z | Waiting for Juice Shop (up to 60s)...
curl: (7) Failed to connect to juice port 3000 after 1 ms: Could not connect to server
2025-10-28T09:40:23Z | Waiting... (2s)
curl: (7) Failed to connect to juice port 3000 after 1 ms: Could not connect to server
2025-10-28T09:40:25Z | Waiting... (4s)
curl: (7) Failed to connect to juice port 3000 after 1 ms: Could not connect to server
2025-10-28T09:40:27Z | Waiting... (6s)
2025-10-28T09:40:27Z | Juice Shop reachable (HTTP 200)
2025-10-28T09:40:27Z | Prepared 6 SQLi payloads.
2025-10-28T09:40:27Z | Host log dir /app/logs writable ‚Äî copying payloads for detection.
2025-10-28T09:40:27Z | Sending payload 1/6 -> /tmp/payload_1.json
2025-10-28T09:40:27Z | PAYLOAD 1 | HTTP 500 | SNIPPET:            SyntaxError: Expected &#39;,&#39; or &#39;}&#39; after property value in JSON at position 29 (line 1 column 30)    * {  margin:   

[...]

 **Analysis complete** - generated by PurpleLab-lite harness.
```
---

## ‚ÑπÔ∏è Note about HTTP responses, snippets and ‚Äúerrors‚Äù in the report

While running attack scenarios you may see HTTP response codes like **500**, **401**, etc. appear in the attacker logs and the generated report. This is expected and not an indication of a harness failure.

**HTTP 500 (Internal Server Error)** - typically occurs when sending intentionally malformed SQLi payloads. Juice Shop returns 500 for such malformed input, that‚Äôs expected since we intentionally test error-handling and parsing paths.

**HTTP 401 (Unauthorized)** - appears for login attempts with incorrect credentials. Again, expected for login-focused attack payloads.

**Snippets in the report** - the harness captures a short response snippet (first bytes) to demonstrate what the attacker observed. These snippets help validate that payloads were processed and reveal whether error messages or stack traces were returned, useful for Purple Team analysis and detection tuning.

So: **500/401 + snippets = normal**. They provide valuable context for detection development and incident analysis and are expected when sending intentionally malformed or unauthenticated payloads, they are useful for detection tuning.

---

## ‚ö° Contribution

Contributions are welcome!

* Add new attack scenarios
* Extend YARA rules for additional IoCs
* Improve report formatting

Please submit a **pull request** or **issue** on GitHub.

---

## üìú License

This project is licensed under the **MIT License** - see [LICENSE](./LICENSE) for details.
